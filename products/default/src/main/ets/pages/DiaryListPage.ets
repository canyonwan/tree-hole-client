import { router } from '@kit.ArkUI';
import { DiaryService } from '../services/DiaryService';
import { DiaryModel, MOOD_CONFIG } from '../models/DiaryModel';
import { AppTheme } from '../theme/AppTheme';
import { UIUtils } from '../utils/UIUtils';
import { Logger } from '@ohos/common';

const logger: Logger = new Logger();

@Component
export struct DiaryListPage {
  @State diaries: DiaryModel[] = [];
  @State isLoading: boolean = true;
  private diaryService: DiaryService = new DiaryService(getContext(this));
  private scroller: Scroller = new Scroller();

  async aboutToAppear() {
    await this.loadDiaries();
  }

  /**
   * åŠ è½½æ—¥è®°åˆ—è¡¨
   */
  async loadDiaries() {
    try {
      this.isLoading = true;
      this.diaries = await this.diaryService.getAllDiaries();
      logger.info('DiaryListPage', `Loaded ${this.diaries.length} diaries`);
    } catch (err) {
      logger.error('DiaryListPage', `Load diaries failed: ${JSON.stringify(err)}`);
      UIUtils.showError('åŠ è½½å¤±è´¥');
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åˆ é™¤æ—¥è®°
   */
  async deleteDiary(diary: DiaryModel) {
    try {
      const result = await UIUtils.showConfirmDialog({
        title: 'åˆ é™¤æ—¥è®°',
        message: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ',
        buttons: [
          { text: 'å–æ¶ˆ', color: AppTheme.TEXT_SECONDARY },
          { text: 'åˆ é™¤', color: AppTheme.ERROR_COLOR }
        ]
      });
      
      if (result.index === 1 && diary.id) {
        await this.diaryService.deleteDiary(diary.id);
        await this.loadDiaries();
        UIUtils.showSuccess('å·²åˆ é™¤');
      }
    } catch (err) {
      logger.error('DiaryListPage', `Delete diary failed: ${JSON.stringify(err)}`);
    }
  }

  /**
   * èŽ·å–å¿ƒæƒ…ä¿¡æ¯
   */
  getMoodInfo(mood: string): string {
    const moodInfo = MOOD_CONFIG.find(m => m.type === mood);
    return moodInfo ? moodInfo.emoji : 'ðŸ˜Š';
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸ
   */
  formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${month}æœˆ${day}æ—¥`;
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´
   */
  formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  build() {
    Stack() {
      if (this.isLoading) {
        // åŠ è½½ä¸­
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color(AppTheme.PRIMARY_COLOR)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.diaries.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Image($r('sys.symbol.book'))
            .width(80)
            .height(80)
            .fillColor(AppTheme.TEXT_PLACEHOLDER)
            .margin({ bottom: AppTheme.SPACING_NORMAL })

          Text('è¿˜æ²¡æœ‰æ—¥è®°')
            .fontSize(AppTheme.FONT_SIZE_MEDIUM)
            .fontColor(AppTheme.TEXT_SECONDARY)

          Text('ç‚¹å‡»å³ä¸‹è§’+å·å¼€å§‹è®°å½•')
            .fontSize(AppTheme.FONT_SIZE_SMALL)
            .fontColor(AppTheme.TEXT_PLACEHOLDER)
            .margin({ top: AppTheme.SPACING_SMALL })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .opacity(0.6)
      } else {
        // æ—¥è®°åˆ—è¡¨
        List({ scroller: this.scroller }) {
          ForEach(this.diaries, (diary: DiaryModel, index: number) => {
            ListItem() {
              this.DiaryCard(diary)
            }
            .margin({
              left: AppTheme.SPACING_NORMAL,
              right: AppTheme.SPACING_NORMAL,
              top: index === 0 ? AppTheme.SPACING_NORMAL : AppTheme.SPACING_SMALL,
              bottom: index === this.diaries.length - 1 ? 80 : AppTheme.SPACING_SMALL
            })
            .onClick(() => {
              router.pushUrl({
                url: 'pages/DiaryEditPage',
                params: { diaryId: diary.id }
              }).catch((err: Error) => {
                logger.error('DiaryListPage', `Router failed: ${err.message}`);
              });
            })
            .gesture(
              LongPressGesture()
                .onAction(() => {
                  this.deleteDiary(diary);
                })
            )
          }, (diary: DiaryModel) => diary.id?.toString())
        }
        .width('100%')
        .height('100%')
        .edgeEffect(EdgeEffect.Spring)
      }

      // æ·»åŠ æŒ‰é’®
      Button() {
        Image($r('sys.symbol.plus'))
          .width(28)
          .height(28)
          .fillColor(AppTheme.TEXT_WHITE)
      }
      .width(60)
      .height(60)
      .backgroundColor(AppTheme.PRIMARY_COLOR)
      .borderRadius(AppTheme.RADIUS_ROUND)
      .position({ x: '85%', y: '85%' })
      .translate({ x: '-50%', y: '-50%' })
      .shadow({
        radius: 12,
        color: AppTheme.PRIMARY_COLOR,
        offsetY: 4
      })
      .onClick(() => {
        router.pushUrl({
          url: 'pages/DiaryEditPage'
        }).catch((err: Error) => {
          logger.error('DiaryListPage', `Router failed: ${err.message}`);
        });
      })
      .scale({ x: 1, y: 1 })
      .animation({
        duration: 200,
        curve: Curve.FastOutSlowIn
      })
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  DiaryCard(diary: DiaryModel) {
    Column() {
      // æ ‡é¢˜å’Œå¿ƒæƒ…
      Row() {
        Text(diary.title || 'æ— æ ‡é¢˜')
          .fontSize(AppTheme.FONT_SIZE_MEDIUM)
          .fontColor(AppTheme.TEXT_PRIMARY)
          .fontWeight(FontWeight.Medium)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)

        Text(this.getMoodInfo(diary.mood))
          .fontSize(24)
          .margin({ left: AppTheme.SPACING_SMALL })
      }
      .width('100%')
      .margin({ bottom: AppTheme.SPACING_SMALL })

      // å†…å®¹é¢„è§ˆ
      Text(diary.content)
        .fontSize(AppTheme.FONT_SIZE_NORMAL)
        .fontColor(AppTheme.TEXT_SECONDARY)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .margin({ bottom: AppTheme.SPACING_SMALL })

      // æ ‡ç­¾
      if (diary.tags && diary.tags !== '[]') {
        Row() {
          ForEach(this.diaryService.parseTags(diary.tags).slice(0, 3), (tag: string) => {
            Text(`#${tag}`)
              .fontSize(AppTheme.FONT_SIZE_SMALL)
              .fontColor(AppTheme.PRIMARY_COLOR)
              .backgroundColor(AppTheme.PRIMARY_COLOR + '20')
              .padding({
                left: AppTheme.SPACING_SMALL,
                right: AppTheme.SPACING_SMALL,
                top: 4,
                bottom: 4
              })
              .borderRadius(AppTheme.RADIUS_SMALL)
              .margin({ right: AppTheme.SPACING_SMALL })
          })
        }
        .margin({ bottom: AppTheme.SPACING_SMALL })
      }

      // æ—¥æœŸ
      Row() {
        Text(this.formatDate(diary.createTime))
          .fontSize(AppTheme.FONT_SIZE_SMALL)
          .fontColor(AppTheme.TEXT_PLACEHOLDER)

        Text(this.formatTime(diary.createTime))
          .fontSize(AppTheme.FONT_SIZE_SMALL)
          .fontColor(AppTheme.TEXT_PLACEHOLDER)
          .margin({ left: AppTheme.SPACING_SMALL })
      }
    }
    .width('100%')
    .padding(AppTheme.SPACING_NORMAL)
    .backgroundColor(AppTheme.CARD_BACKGROUND)
    .borderRadius(AppTheme.RADIUS_LARGE)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetY: 2
    })
    .transition({
      type: TransitionType.Insert,
      opacity: 0,
      translate: { y: 50 }
    })
    .animation({
      duration: 300,
      curve: Curve.EaseOut
    })
  }
}

