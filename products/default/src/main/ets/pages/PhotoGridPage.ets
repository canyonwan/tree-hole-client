import { router } from '@kit.ArkUI';
import { PhotoService } from '../services/PhotoService';
import { PhotoModel } from '../models/PhotoModel';
import { AppTheme } from '../theme/AppTheme';
import { UIUtils } from '../utils/UIUtils';
import { Logger } from '@ohos/common';

const logger: Logger = new Logger();

@Component
export struct PhotoGridPage {
  @State photos: PhotoModel[] = [];
  @State isLoading: boolean = true;
  private photoService: PhotoService = new PhotoService(getContext(this));

  async aboutToAppear() {
    await this.loadPhotos();
  }

  /**
   * åŠ è½½ç…§ç‰‡åˆ—è¡¨
   */
  async loadPhotos() {
    try {
      this.isLoading = true;
      this.photos = await this.photoService.getAllPhotos();
      logger.info('PhotoGridPage', `Loaded ${this.photos.length} photos`);
    } catch (err) {
      logger.error('PhotoGridPage', `Load photos failed: ${JSON.stringify(err)}`);
      UIUtils.showError('åŠ è½½å¤±è´¥');
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * é€‰æ‹©å¹¶æ·»åŠ ç…§ç‰‡
   */
  async addPhotos() {
    try {
      const uris = await this.photoService.selectPhotos();
      
      if (uris && uris.length > 0) {
        UIUtils.showLoading('æ­£åœ¨ä¿å­˜...');
        
        for (const uri of uris) {
          await this.photoService.savePhoto(uri, '');
        }
        
        await this.loadPhotos();
        UIUtils.showSuccess('æ·»åŠ æˆåŠŸ');
      }
    } catch (err) {
      logger.error('PhotoGridPage', `Add photos failed: ${JSON.stringify(err)}`);
      UIUtils.showError('æ·»åŠ å¤±è´¥');
    }
  }

  /**
   * åˆ é™¤ç…§ç‰‡
   */
  async deletePhoto(photo: PhotoModel) {
    try {
      const result = await UIUtils.showConfirmDialog({
        title: 'åˆ é™¤ç…§ç‰‡',
        message: 'ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ',
        buttons: [
          { text: 'å–æ¶ˆ', color: AppTheme.TEXT_SECONDARY },
          { text: 'åˆ é™¤', color: AppTheme.ERROR_COLOR }
        ]
      });
      
      if (result.index === 1 && photo.id) {
        await this.photoService.deletePhoto(photo.id, photo.filePath);
        await this.loadPhotos();
        UIUtils.showSuccess('å·²åˆ é™¤');
      }
    } catch (err) {
      logger.error('PhotoGridPage', `Delete photo failed: ${JSON.stringify(err)}`);
    }
  }

  build() {
    Stack() {
      if (this.isLoading) {
        // åŠ è½½ä¸­
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color(AppTheme.PRIMARY_COLOR)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.photos.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ðŸ“·')
            .fontSize(80)
            .fontColor(AppTheme.TEXT_PLACEHOLDER)
            .margin({ bottom: AppTheme.SPACING_NORMAL })

          Text('è¿˜æ²¡æœ‰ç…§ç‰‡')
            .fontSize(AppTheme.FONT_SIZE_MEDIUM)
            .fontColor(AppTheme.TEXT_SECONDARY)

          Text('ç‚¹å‡»å³ä¸‹è§’+å·æ·»åŠ ç…§ç‰‡')
            .fontSize(AppTheme.FONT_SIZE_SMALL)
            .fontColor(AppTheme.TEXT_PLACEHOLDER)
            .margin({ top: AppTheme.SPACING_SMALL })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .opacity(0.6)
      } else {
        // ç…§ç‰‡ç½‘æ ¼
        Grid() {
          ForEach(this.photos, (photo: PhotoModel, index: number) => {
            GridItem() {
              Stack() {
                Image(photo.filePath)
                  .width('100%')
                  .height('100%')
                  .objectFit(ImageFit.Cover)
                  .borderRadius(AppTheme.RADIUS_MEDIUM)
              }
              .width('100%')
              .aspectRatio(1)
              .shadow({
                radius: 4,
                color: '#00000015',
                offsetY: 2
              })
              .transition({
                type: TransitionType.Insert,
                opacity: 0,
                scale: { x: 0.8, y: 0.8 }
              })
              .animation({
                duration: 300,
                curve: Curve.EaseInOut
              })
            }
            .onClick(() => {
              router.pushUrl({
                url: 'pages/PhotoDetailPage',
                params: {
                  photoId: photo.id,
                  currentIndex: index
                }
              }).catch((err: Error) => {
                UIUtils.showError('æ‰“å¼€å¤±è´¥');
              });
            })
            .gesture(
              LongPressGesture()
                .onAction(() => {
                  this.deletePhoto(photo);
                })
            )
          }, (photo: PhotoModel) => photo.id?.toString())
        }
        .columnsTemplate('1fr 1fr 1fr')
        .columnsGap(AppTheme.SPACING_SMALL)
        .rowsGap(AppTheme.SPACING_SMALL)
        .padding({
          left: AppTheme.SPACING_NORMAL,
          right: AppTheme.SPACING_NORMAL,
          top: AppTheme.SPACING_NORMAL,
          bottom: 80
        })
        .width('100%')
        .height('100%')
      }

      // æ·»åŠ æŒ‰é’®
      Button() {
        Image($r('sys.symbol.plus'))
          .width(28)
          .height(28)
          .fillColor(AppTheme.TEXT_WHITE)
      }
      .width(60)
      .height(60)
      .backgroundColor(AppTheme.PRIMARY_COLOR)
      .borderRadius(AppTheme.RADIUS_ROUND)
      .position({ x: '85%', y: '85%' })
      .translate({ x: '-50%', y: '-50%' })
      .shadow({
        radius: 12,
        color: AppTheme.PRIMARY_COLOR,
        offsetY: 4
      })
      .onClick(() => {
        this.addPhotos();
      })
      .scale({ x: 1, y: 1 })
      .animation({
        duration: 200,
        curve: Curve.FastOutSlowIn
      })
    }
    .width('100%')
    .height('100%')
  }
}

