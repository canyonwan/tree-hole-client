import { router } from '@kit.ArkUI';
import { AuthService } from '../services/AuthService';
import { AppTheme } from '../theme/AppTheme';
import { Logger } from '@ohos/common';

const logger: Logger = new Logger();

@Entry
@Component
struct LoginPage {
  @State password: string = '';
  @State confirmPassword: string = '';
  @State isSettingPassword: boolean = false;
  @State errorMessage: string = '';
  @State showError: boolean = false;
  @State shakeAnimation: boolean = false;
  private authService: AuthService = new AuthService(getContext(this));
  private maxPasswordLength: number = 6;

  async aboutToAppear() {
    const hasPassword = await this.authService.hasSetPassword();
    this.isSettingPassword = !hasPassword;
    logger.info('LoginPage', `Setting password mode: ${this.isSettingPassword}`);
  }

  /**
   * Â§ÑÁêÜÊï∞Â≠óÊåâÈíÆÁÇπÂáª
   */
  handleNumberClick(num: string) {
    if (this.password.length < this.maxPasswordLength) {
      this.password += num;
      
      // Ëá™Âä®È™åËØÅÔºàÁôªÂΩïÊ®°ÂºèÔºâ
      if (!this.isSettingPassword && this.password.length === this.maxPasswordLength) {
        this.verifyPassword();
      }
    }
  }

  /**
   * Âà†Èô§ÊúÄÂêé‰∏Ä‰Ωç
   */
  handleDelete() {
    if (this.password.length > 0) {
      this.password = this.password.slice(0, -1);
    }
  }

  /**
   * È™åËØÅÂØÜÁ†Å
   */
  async verifyPassword() {
    try {
      const isValid = await this.authService.verifyPassword(this.password);
      if (isValid) {
        logger.info('LoginPage', 'Password verified successfully');
        router.replaceUrl({
          url: 'pages/MainPage'
        }).catch((err: Error) => {
          logger.error('LoginPage', `Router failed: ${err.message}`);
        });
      } else {
        this.showErrorMessage('ÂØÜÁ†ÅÈîôËØØÔºåËØ∑ÈáçËØï');
        this.password = '';
      }
    } catch (err) {
      logger.error('LoginPage', `Verify failed: ${JSON.stringify(err)}`);
      this.showErrorMessage('È™åËØÅÂ§±Ë¥•');
      this.password = '';
    }
  }

  /**
   * ËÆæÁΩÆÂØÜÁ†Å - Á¨¨‰∏ÄÊ¨°ËæìÂÖ•
   */
  handleSetPasswordFirst() {
    if (this.password.length === this.maxPasswordLength) {
      this.confirmPassword = this.password;
      this.password = '';
    }
  }

  /**
   * ËÆæÁΩÆÂØÜÁ†Å - Á°ÆËÆ§ËæìÂÖ•
   */
  async handleSetPasswordConfirm() {
    if (this.password.length === this.maxPasswordLength) {
      if (this.password === this.confirmPassword) {
        try {
          await this.authService.setPassword(this.password);
          logger.info('LoginPage', 'Password set successfully');
          router.replaceUrl({
            url: 'pages/MainPage'
          }).catch((err: Error) => {
            logger.error('LoginPage', `Router failed: ${err.message}`);
          });
        } catch (err) {
          logger.error('LoginPage', `Set password failed: ${JSON.stringify(err)}`);
          this.showErrorMessage('ËÆæÁΩÆÂØÜÁ†ÅÂ§±Ë¥•');
          this.resetPasswordSetting();
        }
      } else {
        this.showErrorMessage('‰∏§Ê¨°ÂØÜÁ†Å‰∏ç‰∏ÄËá¥');
        this.resetPasswordSetting();
      }
    }
  }

  /**
   * ÈáçÁΩÆÂØÜÁ†ÅËÆæÁΩÆÁä∂ÊÄÅ
   */
  resetPasswordSetting() {
    this.password = '';
    this.confirmPassword = '';
  }

  /**
   * ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
   */
  showErrorMessage(message: string) {
    this.errorMessage = message;
    this.showError = true;
    this.shakeAnimation = true;

    setTimeout(() => {
      this.showError = false;
      this.shakeAnimation = false;
    }, 2000);
  }

  /**
   * ÊåáÁ∫πËØÜÂà´
   */
  async handleBiometric() {
    try {
      const isEnabled = await this.authService.isBiometricEnabled();
      if (!isEnabled) {
        this.showErrorMessage('ÊåáÁ∫πËØÜÂà´Êú™ÂêØÁî®');
        return;
      }

      const success = await this.authService.authenticateWithBiometric();
      if (success) {
        logger.info('LoginPage', 'Biometric auth success');
        router.replaceUrl({
          url: 'pages/MainPage'
        }).catch((err: Error) => {
          logger.error('LoginPage', `Router failed: ${err.message}`);
        });
      } else {
        this.showErrorMessage('ÊåáÁ∫πËØÜÂà´Â§±Ë¥•');
      }
    } catch (err) {
      logger.error('LoginPage', `Biometric failed: ${JSON.stringify(err)}`);
      this.showErrorMessage('ÊåáÁ∫πËØÜÂà´Âá∫Èîô');
    }
  }

  build() {
    Column() {
      // Ê†áÈ¢òÂå∫Âüü
      Column() {
        Text('ÊàëÁöÑÁßòÂØÜÁ©∫Èó¥')
          .fontSize(AppTheme.FONT_SIZE_TITLE)
          .fontColor(AppTheme.TEXT_PRIMARY)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: AppTheme.SPACING_SMALL })

        Text(this.isSettingPassword ? 
          (this.confirmPassword ? 'ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å' : 'ËÆæÁΩÆ6‰ΩçÊï∞Â≠óÂØÜÁ†Å') : 
          'ËØ∑ËæìÂÖ•ÂØÜÁ†Å')
          .fontSize(AppTheme.FONT_SIZE_NORMAL)
          .fontColor(AppTheme.TEXT_SECONDARY)
      }
      .margin({ top: 100, bottom: 60 })

      // ÂØÜÁ†ÅÁÇπÊåáÁ§∫Âô®
      Row() {
        ForEach([0, 1, 2, 3, 4, 5], (index: number) => {
          Circle({ width: 16, height: 16 })
            .fill(index < this.password.length ? AppTheme.PRIMARY_COLOR : AppTheme.DIVIDER_COLOR)
            .margin({ left: index === 0 ? 0 : 20 })
            .animation({
              duration: 200,
              curve: Curve.EaseInOut
            })
        })
      }
      .margin({ bottom: 40 })
      .rotate({ angle: this.shakeAnimation ? 10 : 0 })
      .animation({
        duration: 100,
        iterations: 3,
        curve: Curve.Sharp
      })

      // ÈîôËØØÊèêÁ§∫
      if (this.showError) {
        Text(this.errorMessage)
          .fontSize(AppTheme.FONT_SIZE_SMALL)
          .fontColor(AppTheme.ERROR_COLOR)
          .margin({ bottom: 20 })
          .opacity(this.showError ? 1 : 0)
          .animation({
            duration: 300,
            curve: Curve.EaseInOut
          })
      }

      // Êï∞Â≠óÈîÆÁõò
      Column() {
        ForEach([['1', '2', '3'], ['4', '5', '6'], ['7', '8', '9']], (row: string[]) => {
          Row() {
            ForEach(row, (num: string) => {
              Button(num)
                .width(70)
                .height(70)
                .fontSize(AppTheme.FONT_SIZE_LARGE)
                .fontColor(AppTheme.TEXT_PRIMARY)
                .backgroundColor(AppTheme.CARD_BACKGROUND)
                .borderRadius(AppTheme.RADIUS_ROUND)
                .margin(AppTheme.SPACING_MEDIUM)
                .stateStyles({
                  pressed: {
                    .scale({ x: 0.95, y: 0.95 })
                  },
                  normal: {
                    .scale({ x: 1, y: 1 })
                  }
                })
                .onClick(() => {
                  this.handleNumberClick(num);
                })
                .animation({
                  duration: 100,
                  curve: Curve.FastOutSlowIn
                })
            })
          }
        })

        // ÊúÄÂêé‰∏ÄË°åÔºöÊåáÁ∫π„ÄÅ0„ÄÅÂà†Èô§
        Row() {
          // ÊåáÁ∫πÊåâÈíÆÔºà‰ªÖÁôªÂΩïÊ®°ÂºèÊòæÁ§∫Ôºâ
          if (!this.isSettingPassword) {
            Button() {
              Text('üëÜ')
                .fontSize(30)
                .fontColor(AppTheme.PRIMARY_COLOR)
            }
            .width(70)
            .height(70)
            .backgroundColor(AppTheme.CARD_BACKGROUND)
            .borderRadius(AppTheme.RADIUS_ROUND)
            .margin(AppTheme.SPACING_MEDIUM)
            .onClick(() => {
              this.handleBiometric();
            })
          } else {
            Blank()
              .width(70)
              .margin(AppTheme.SPACING_MEDIUM)
          }

          // Êï∞Â≠ó0
          Button('0')
            .width(70)
            .height(70)
            .fontSize(AppTheme.FONT_SIZE_LARGE)
            .fontColor(AppTheme.TEXT_PRIMARY)
            .backgroundColor(AppTheme.CARD_BACKGROUND)
            .borderRadius(AppTheme.RADIUS_ROUND)
            .margin(AppTheme.SPACING_MEDIUM)
            .onClick(() => {
              this.handleNumberClick('0');
            })

          // Âà†Èô§ÊåâÈíÆ
          Button() {
            Image($r('sys.symbol.delete_left'))
              .width(30)
              .height(30)
              .fillColor(AppTheme.TEXT_SECONDARY)
          }
          .width(70)
          .height(70)
          .backgroundColor(AppTheme.CARD_BACKGROUND)
          .borderRadius(AppTheme.RADIUS_ROUND)
          .margin(AppTheme.SPACING_MEDIUM)
          .onClick(() => {
            this.handleDelete();
          })
        }
      }
      .margin({ top: 40 })

      // Á°ÆËÆ§ÊåâÈíÆÔºàËÆæÁΩÆÂØÜÁ†ÅÊ®°ÂºèÔºâ
      if (this.isSettingPassword && this.password.length === this.maxPasswordLength) {
        Button(this.confirmPassword ? 'Á°ÆËÆ§ËÆæÁΩÆ' : 'ÁªßÁª≠')
          .width(200)
          .height(48)
          .fontSize(AppTheme.FONT_SIZE_MEDIUM)
          .fontColor(AppTheme.TEXT_WHITE)
          .backgroundColor(AppTheme.PRIMARY_COLOR)
          .borderRadius(AppTheme.RADIUS_LARGE)
          .margin({ top: 40 })
          .onClick(() => {
            if (this.confirmPassword) {
              this.handleSetPasswordConfirm();
            } else {
              this.handleSetPasswordFirst();
            }
          })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppTheme.BACKGROUND_COLOR)
  }
}

